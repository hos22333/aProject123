{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">Add New Project</h2>
    <form method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-4">{{ form.name }}</div>
            <div class="col-md-4">{{ form.client_name }}</div>
            <div class="col-md-4">{{ form.capacity }}</div>
        </div>
        <button type="submit" class="btn btn-primary mt-2">Save</button>
    </form>
    
    <h3 class="mt-4">Projects List</h3>
    <table class="table table-bordered mt-2">
        <thead>
            <tr>
                <th>Name</th>
                <th>Client Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for project in projects %}
            <tr>
                <td>{{ project.name }}</td>
                <td>{{ project.client_name }}</td>
                <td>
                    <a href="{% url 'edit_project' project.id %}" class="btn btn-warning btn-sm">Edit</a>
                    <form action="{% url 'delete_project' project.id %}" method="POST" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>                    
                    <button class="btn btn-info btn-sm" onclick="showDetails('{{ project.name }}', '{{ project.client_name }}', '{{ project.capacity }}')">Show All</button>
                    <button class="btn btn-success btn-sm" onclick="reviewMachines('{{ project.id }}')">Review Machines</button>
                    <a href="{% url 'generate_report' project.id %}" class="btn btn-secondary btn-sm">Generate Report</a>

                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Project Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>Name:</strong> <span id="modalName"></span></p>
                <p><strong>Client Name:</strong> <span id="modalClient"></span></p>
                <p><strong>Capacity:</strong> <span id="modalCapacity"></span></p>
            </div>
        </div>
    </div>
</div>



<!-- Modal -->
<div class="modal fade" id="reviewMachinesModal" tabindex="-1" aria-labelledby="reviewMachinesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewMachinesModalLabel">Machines for <span id="modalProjectName"></span></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Created At</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody id="machinesTableBody">
                        <!-- Machines will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function showDetails(name, client, capacity) {
    document.getElementById('modalName').textContent = name;
    document.getElementById('modalClient').textContent = client;
    document.getElementById('modalCapacity').textContent = capacity;
    $('#detailsModal').modal('show');
}
</script>

<script>
    function reviewMachines(projectId) {
        // Set the modal project name
        document.getElementById('modalProjectName').textContent = "Loading...";
    
        // Fetch machine data using AJAX
        fetch(`/Mechanical/get_machines/${projectId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('modalProjectName').textContent = data.project_name;
    
                let machinesTableBody = document.getElementById('machinesTableBody');
                machinesTableBody.innerHTML = "";  // Clear existing rows
    
                if (data.machines.length > 0) {
                    data.machines.forEach(machine => {
                        let row = `<tr>
                            <td>${machine.oSec00Field01}</td>
                            <td>${machine.oSec00Field02}</td>
                            <td>${machine.oSec00Field03}</td>
                            <td>${machine.oSec01Field01}</td>
                            <td>${machine.oSec01Field02}</td>
                        </tr>`;
                        machinesTableBody.innerHTML += row;
                    });
                } else {
                    machinesTableBody.innerHTML = "<tr><td colspan='3' class='text-center'>No machines found.</td></tr>";
                }
    
                // Show modal
                $('#reviewMachinesModal').modal('show');
            })
            .catch(error => console.error('Error:', error));
    }
    </script>
    
{% endblock %}
