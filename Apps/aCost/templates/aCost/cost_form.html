{% extends "base.html" %}

{% block content %}
<br><br><br><br>

<head>
    <title>Cost Calculation Form</title>
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function loadSizes(itemId, categoryId, row, callback = null) {
            if (!itemId) return;

            fetch(`/Cost/get_sizes/${itemId}/`)
                .then(response => response.json())
                .then(data => {
                    let sizeSelect = document.getElementById(`size_${categoryId}_${row}`);
                    sizeSelect.innerHTML = '<option value="">Select Size</option>';

                    data.sizes.forEach(size => {
                        let option = document.createElement('option');
                        option.value = size.id;
                        option.textContent = size.name;
                        sizeSelect.appendChild(option);
                    });

                    if (callback) {
                        callback(sizeSelect, data.sizes);
                    }
                })
                .catch(error => console.error('Error fetching sizes:', error));
        }

        function loadPrice(sizeId, categoryId, row) {
            if (!sizeId) return;

            fetch(`/Cost/get_price/${sizeId}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById(`price_${categoryId}_${row}`).value = data.price;
                    calculateCost(categoryId, row);
                })
                .catch(error => console.error('Error fetching price:', error));
        }

        function calculateCost(categoryId, row) {
            let price = parseFloat(document.getElementById(`price_${categoryId}_${row}`).value) || 0;
            let quantity = parseInt(document.getElementById(`quantity_${categoryId}_${row}`).value) || 0;
            document.getElementById(`total_${categoryId}_${row}`).value = (price * quantity).toFixed(2);
        }

        function selectOptionByValue(selectElement, value) {
            for (let i = 0; i < selectElement.options.length; i++) {
                if (selectElement.options[i].value === value.toString()) {
                    selectElement.selectedIndex = i;
                    return true;
                }
            }
            return false;
        }


    
    </script>

    <script>
        async function autoSelectItems() {
            // Get the selected project type value
            const projectType = document.getElementById('project_type').value;

            // Pass projectType as a query parameter
            const response = await fetch("{% url 'get_autofill_data' %}?project_type=" + encodeURIComponent(projectType));
            const { item_ids, size_ids, quantity_map } = await response.json();

            const itemSizeMap = {
                item_1_1: { itemId: item_ids['Cat01Row01Field01'], sizeId: size_ids['Cat01Row01Field02'] },
                item_1_2: { itemId: item_ids['Cat01Row02Field01'], sizeId: size_ids['Cat01Row02Field02'] },
                item_2_1: { itemId: item_ids['Cat02Row01Field01'], sizeId: size_ids['Cat02Row01Field02'] },
                item_2_2: { itemId: item_ids['Cat02Row02Field01'], sizeId: size_ids['Cat02Row02Field02'] },
                item_3_1: { itemId: item_ids['Cat03Row01Field01'], sizeId: size_ids['Cat03Row01Field02'] },
                item_3_2: { itemId: item_ids['Cat03Row02Field01'], sizeId: size_ids['Cat03Row02Field02'] },
            };

            Object.entries(itemSizeMap).forEach(([elementId, { itemId, sizeId }]) => {
                const [_, cat, row] = elementId.split("_");
                const itemSelect = document.getElementById(elementId);
                if (itemSelect && selectOptionByValue(itemSelect, itemId)) {
                    loadSizes(itemId, cat, row, (sizeSelect) => {
                        selectOptionByValue(sizeSelect, sizeId);
                        loadPrice(sizeId, cat, row);
                    });
                }
            });

            Object.entries(quantity_map).forEach(([key, qty]) => {
                const input = document.getElementById(`quantity_${key}`);
                if (input) {
                    input.value = qty;
                    const [catId, row] = key.split("_");
                    calculateCost(catId, row);
                }
            });
        }

        function selectOptionByValue(selectElement, value) {
            if (!selectElement) return false;
            for (let i = 0; i < selectElement.options.length; i++) {
                if (selectElement.options[i].value == value) {
                    selectElement.selectedIndex = i;
                    selectElement.dispatchEvent(new Event('change'));
                    return true;
                }
            }
            return false;
        }

        document.addEventListener("DOMContentLoaded", autoSelectItems);
    </script>




    <script>
        function calculateCategorySubtotal(categoryId) {
            let subtotal = 0;
            const totalInputs = document.querySelectorAll(`input[id^='total_${categoryId}_']`);
            totalInputs.forEach(input => {
                subtotal += parseFloat(input.value) || 0;
            });
            document.getElementById(`subtotal_${categoryId}`).value = subtotal.toFixed(2);
            calculateGrandTotal();
        }

        function calculateCost(categoryId, row) {
            let price = parseFloat(document.getElementById(`price_${categoryId}_${row}`).value) || 0;
            let quantity = parseInt(document.getElementById(`quantity_${categoryId}_${row}`).value) || 0;
            let total = price * quantity;
            document.getElementById(`total_${categoryId}_${row}`).value = total.toFixed(2);
            calculateCategorySubtotal(categoryId);
        }

        function calculateGrandTotal() {
            let grandTotal = 0;
            const subtotals = document.querySelectorAll("input[id^='subtotal_']");
            subtotals.forEach(input => {
                grandTotal += parseFloat(input.value) || 0;
            });
            document.getElementById("grand_total").value = grandTotal.toFixed(2);
        }

    </script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


<script>
    function exportToExcel() {
        const data = [];
        const categories = [1, 2, 3];

        categories.forEach(cat => {
            let categorySubtotal = 0;
            for (let row = 1; row <= 2; row++) {
                const itemSelect = document.getElementById(`item_${cat}_${row}`);
                const sizeSelect = document.getElementById(`size_${cat}_${row}`);
                const quantityInput = document.getElementById(`quantity_${cat}_${row}`);
                const priceInput = document.getElementById(`price_${cat}_${row}`);
                const totalInput = document.getElementById(`total_${cat}_${row}`);

                if (itemSelect && itemSelect.value) {
                    const itemName = itemSelect.options[itemSelect.selectedIndex]?.text || '';
                    const sizeName = sizeSelect?.options[sizeSelect.selectedIndex]?.text || '';
                    const quantity = quantityInput?.value || '';
                    const price = priceInput?.value || '';
                    const total = totalInput?.value || '';

                    categorySubtotal += parseFloat(total) || 0;

                    data.push({
                        Category: `Category ${cat}`,
                        Item: itemName,
                        Size: sizeName,
                        Quantity: quantity,
                        Price: price,
                        Total: total
                    });
                }
            }

            // Add subtotal row
            data.push({
                Category: `Subtotal for Category ${cat}`,
                Item: '',
                Size: '',
                Quantity: '',
                Price: '',
                Total: categorySubtotal.toFixed(2)
            });

            // Empty row for spacing
            data.push({});
        });

        // Add Grand Total
        const grandTotal = document.getElementById("grand_total")?.value || '0';
        data.push({
            Category: 'Grand Total',
            Item: '',
            Size: '',
            Quantity: '',
            Price: '',
            Total: grandTotal
        });

        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Cost Summary");

        XLSX.writeFile(workbook, "Cost_Summary.xlsx");
    }
</script>

</head>

<body>


    

    <form onsubmit="return false;">

        <!-- Combo Box Example -->
        <div>
            <label for="project_type"><strong>Project Type:</strong></label>
            <select id="project_type" name="project_type">
                <option value="OptionA">OptionA</option>
                <option value="OptionB">OptionB</option>
                <option value="OptionC">OptionC</option>
                <option value="OptionD">OptionD</option>
            </select>
        </div>
        <br>



        <!-- Category 1 -->
        <h3>{{ categories.0.name }}</h3>
        <!-- Row 1 -->
        <div>
            <select id="item_1_1" onchange="loadSizes(this.value, '{{ categories.0.id }}', '1')">
                <option value="">Select Item</option>
                {% for item in categories.0.items.all %}
                    <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>

            <select id="size_1_1" onchange="loadPrice(this.value, '{{ categories.0.id }}', '1')">
                <option value="">Select Size</option>
            </select>

            <input type="number" id="price_1_1" readonly>
            <input type="number" id="quantity_1_1" oninput="calculateCost('{{ categories.0.id }}', '1')">
            <input type="number" id="total_1_1" readonly>
        </div>

        <!-- Row 2 -->
        <div>
            <select id="item_1_2" onchange="loadSizes(this.value, '{{ categories.0.id }}', '2')">
                <option value="">Select Item</option>
                {% for item in categories.0.items.all %}
                    <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>

            <select id="size_1_2" onchange="loadPrice(this.value, '{{ categories.0.id }}', '2')">
                <option value="">Select Size</option>
            </select>

            <input type="number" id="price_1_2" readonly>
            <input type="number" id="quantity_1_2" oninput="calculateCost('{{ categories.0.id }}', '2')">
            <input type="number" id="total_1_2" readonly>
        </div>

        <div>
            <label><strong>Subtotal ({{ categories.0.name }}):</strong></label>
            <input type="number" id="subtotal_1" readonly>
        </div>


        <br>

        <!-- Category 2 -->
        <h3>{{ categories.1.name }}</h3>
        <!-- Row 1 -->
        <div>
            <select id="item_2_1" onchange="loadSizes(this.value, '{{ categories.1.id }}', '1')">
                <option value="">Select Item</option>
                {% for item in categories.1.items.all %}
                    <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>

            <select id="size_2_1" onchange="loadPrice(this.value, '{{ categories.1.id }}', '1')">
                <option value="">Select Size</option>
            </select>

            <input type="number" id="price_2_1" readonly>
            <input type="number" id="quantity_2_1" oninput="calculateCost('{{ categories.1.id }}', '1')">
            <input type="number" id="total_2_1" readonly>
        </div>

        <!-- Row 2 -->
        <div>
            <select id="item_2_2" onchange="loadSizes(this.value, '{{ categories.1.id }}', '2')">
                <option value="">Select Item</option>
                {% for item in categories.1.items.all %}
                    <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>

            <select id="size_2_2" onchange="loadPrice(this.value, '{{ categories.1.id }}', '2')">
                <option value="">Select Size</option>
            </select>

            <input type="number" id="price_2_2" readonly>
            <input type="number" id="quantity_2_2" oninput="calculateCost('{{ categories.1.id }}', '2')">
            <input type="number" id="total_2_2" readonly>
        </div>

        <div>
            <label><strong>Subtotal ({{ categories.1.name }}):</strong></label>
            <input type="number" id="subtotal_2" readonly>
        </div>


        <br>

        <!-- Category 3 -->
        <h3>{{ categories.2.name }}</h3>
        <!-- Row 1 -->
        <div>
            <select id="item_3_1" onchange="loadSizes(this.value, '{{ categories.2.id }}', '1')">
                <option value="">Select Item</option>
                {% for item in categories.2.items.all %}
                    <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>

            <select id="size_3_1" onchange="loadPrice(this.value, '{{ categories.2.id }}', '1')">
                <option value="">Select Size</option>
            </select>

            <input type="number" id="price_3_1" readonly>
            <input type="number" id="quantity_3_1" oninput="calculateCost('{{ categories.2.id }}', '1')">
            <input type="number" id="total_3_1" readonly>
        </div>

        <!-- Row 2 -->
        <div>
            <select id="item_3_2" onchange="loadSizes(this.value, '{{ categories.2.id }}', '2')">
                <option value="">Select Item</option>
                {% for item in categories.2.items.all %}
                    <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>

            <select id="size_3_2" onchange="loadPrice(this.value, '{{ categories.2.id }}', '2')">
                <option value="">Select Size</option>
            </select>

            <input type="number" id="price_3_2" readonly>
            <input type="number" id="quantity_3_2" oninput="calculateCost('{{ categories.2.id }}', '2')">
            <input type="number" id="total_3_2" readonly>
        </div>

        <div>
            <label><strong>Subtotal ({{ categories.2.name }}):</strong></label>
            <input type="number" id="subtotal_3" readonly>
        </div>

        <br>
        <div>
            <label><strong>Grand Total:</strong></label>
            <input type="number" id="grand_total" readonly>
        </div>
        <br>




        <button onclick="submitForm(false)">Save as New</button>
        <button onclick="submitForm(true)">Update Existing</button>
        <button type="button" onclick="autoSelectItems()">Auto Select Sample</button>
        <button onclick="exportToExcel()" class="btn btn-primary">Export to Excel</button>

    </form>
</body>
{% endblock %}
